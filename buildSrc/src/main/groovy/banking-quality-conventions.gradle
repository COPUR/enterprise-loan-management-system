plugins {
    id 'banking-base-conventions'
    id 'jacoco'
    id 'checkstyle'
    id 'pmd'
    id 'com.github.spotbugs'
}

// Quality tools configuration - High cohesion for code quality concerns
jacoco {
    toolVersion = "0.8.14"
}

// Jacoco configuration - Configuration cache safe
jacocoTestReport {
    dependsOn test
    
    reports {
        xml.required = true
        html.required = true
        csv.required = false
    }
    
    // Static exclusion patterns - no project references
    afterEvaluate {
        classDirectories.setFrom(files(classDirectories.files.collect { dir ->
            fileTree(dir: dir, exclude: [
                '**/config/**',
                '**/dto/**', 
                '**/Application.*',
                '**/*Config.*',
                '**/*Test.*'
            ])
        }))
    }
}

jacocoTestCoverageVerification {
    dependsOn jacocoTestReport
    
    violationRules {
        rule {
            limit {
                counter = 'LINE'
                value = 'COVEREDRATIO'
                minimum = 0.83 // Banking standard
            }
        }
        
        rule {
            element = 'CLASS'
            limit {
                counter = 'LINE'
                value = 'COVEREDRATIO'
                minimum = 0.75
            }
            excludes = [
                '*.config.*',
                '*.dto.*',
                '*Application',
                '*Config',
                '*Test'
            ]
        }
    }
}

// PMD configuration
pmd {
    toolVersion = "7.21.0"
    ignoreFailures = false
    ruleSetFiles = files("${rootProject.projectDir}/config/pmd/banking-rules.xml")
    ruleSets = []
}

// Gradle 9 + PMD may fail when report parent folders are not pre-created after clean.
tasks.withType(org.gradle.api.plugins.quality.Pmd).configureEach {
    reports {
        xml.required = true
        html.required = true
    }
    doFirst {
        reports.xml.outputLocation.get().asFile.parentFile.mkdirs()
        reports.html.outputLocation.get().asFile.parentFile.mkdirs()
    }
}

// Checkstyle configuration  
checkstyle {
    toolVersion = '10.12.4'
    configFile = file("${rootProject.projectDir}/config/checkstyle/banking-checkstyle.xml")
    ignoreFailures = false
    maxWarnings = 0
    maxErrors = 0
}

// SpotBugs configuration
spotbugs {
    toolVersion = '4.9.8'
    effort = com.github.spotbugs.snom.Effort.valueOf('MAX')
    // Use HIGH confidence as the enforceable gate during migration to Java 23 toolchain.
    reportLevel = com.github.spotbugs.snom.Confidence.valueOf('HIGH')
    ignoreFailures = false
}

dependencies {
    spotbugs 'com.github.spotbugs:spotbugs:4.9.8'
    // SpotBugs 4.9.x requires commons-lang3 with SystemProperties#getJdkModulePath.
    spotbugs 'org.apache.commons:commons-lang3:3.20.0'
}

// Task dependencies - Clear dependency chain
check.dependsOn jacocoTestCoverageVerification
