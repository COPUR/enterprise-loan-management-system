# FAPI 2.0 + DPoP Monitoring and Metrics Configuration
# This configuration file defines monitoring, alerting, and observability for FAPI 2.0 + DPoP implementation

# Prometheus Metrics Configuration
prometheus:
  enabled: true
  metrics:
    # DPoP-specific metrics
    dpop:
      validation_time:
        name: "dpop_validation_duration_seconds"
        description: "Time taken to validate DPoP proof"
        type: "histogram"
        buckets: [0.01, 0.05, 0.1, 0.2, 0.5, 1.0, 2.0, 5.0]
      validation_success:
        name: "dpop_validation_success_total"
        description: "Total successful DPoP validations"
        type: "counter"
      validation_failure:
        name: "dpop_validation_failure_total"
        description: "Total failed DPoP validations"
        type: "counter"
        labels: ["error_type", "client_id"]
      jti_cache_hits:
        name: "dpop_jti_cache_hits_total"
        description: "DPoP JTI cache hits"
        type: "counter"
      jti_cache_misses:
        name: "dpop_jti_cache_misses_total"
        description: "DPoP JTI cache misses"
        type: "counter"
      replay_attacks:
        name: "dpop_replay_attacks_total"
        description: "Detected DPoP replay attacks"
        type: "counter"
        labels: ["client_id", "jti"]
      nonce_usage:
        name: "dpop_nonce_usage_total"
        description: "DPoP nonce usage statistics"
        type: "counter"
        labels: ["client_id", "status"]
      key_validation_time:
        name: "dpop_key_validation_duration_seconds"
        description: "Time taken to validate DPoP key"
        type: "histogram"
        buckets: [0.001, 0.005, 0.01, 0.05, 0.1, 0.2, 0.5]
    
    # PAR-specific metrics
    par:
      request_processing_time:
        name: "par_request_processing_duration_seconds"
        description: "Time taken to process PAR requests"
        type: "histogram"
        buckets: [0.01, 0.05, 0.1, 0.2, 0.5, 1.0, 2.0]
      request_success:
        name: "par_request_success_total"
        description: "Total successful PAR requests"
        type: "counter"
      request_failure:
        name: "par_request_failure_total"
        description: "Total failed PAR requests"
        type: "counter"
        labels: ["error_type", "client_id"]
      request_uri_usage:
        name: "par_request_uri_usage_total"
        description: "PAR request URI usage"
        type: "counter"
        labels: ["client_id"]
      cache_size:
        name: "par_cache_size"
        description: "Current PAR cache size"
        type: "gauge"
      expired_requests:
        name: "par_expired_requests_total"
        description: "PAR requests that expired"
        type: "counter"
    
    # FAPI-specific metrics
    fapi:
      request_processing_time:
        name: "fapi_request_processing_duration_seconds"
        description: "Time taken to process FAPI requests"
        type: "histogram"
        buckets: [0.01, 0.05, 0.1, 0.2, 0.5, 1.0, 2.0, 5.0]
      security_violations:
        name: "fapi_security_violations_total"
        description: "FAPI security violations detected"
        type: "counter"
        labels: ["violation_type", "client_id", "endpoint"]
      header_validation_failures:
        name: "fapi_header_validation_failures_total"
        description: "FAPI header validation failures"
        type: "counter"
        labels: ["header_name", "client_id"]
      interaction_ids:
        name: "fapi_interaction_ids_total"
        description: "FAPI interaction ID usage"
        type: "counter"
        labels: ["client_id"]
    
    # OAuth2 metrics
    oauth2:
      token_requests:
        name: "oauth2_token_requests_total"
        description: "Total OAuth2 token requests"
        type: "counter"
        labels: ["grant_type", "client_id", "status"]
      token_validation_time:
        name: "oauth2_token_validation_duration_seconds"
        description: "Time taken to validate OAuth2 tokens"
        type: "histogram"
        buckets: [0.001, 0.005, 0.01, 0.05, 0.1, 0.2, 0.5]
      client_authentication_failures:
        name: "oauth2_client_authentication_failures_total"
        description: "OAuth2 client authentication failures"
        type: "counter"
        labels: ["client_id", "auth_method"]
      private_key_jwt_validation_time:
        name: "oauth2_private_key_jwt_validation_duration_seconds"
        description: "Time taken to validate private_key_jwt"
        type: "histogram"
        buckets: [0.001, 0.005, 0.01, 0.05, 0.1, 0.2]
    
    # Security metrics
    security:
      rate_limiting_triggered:
        name: "security_rate_limiting_triggered_total"
        description: "Rate limiting triggered events"
        type: "counter"
        labels: ["client_id", "endpoint"]
      suspicious_activity:
        name: "security_suspicious_activity_total"
        description: "Suspicious activity detected"
        type: "counter"
        labels: ["activity_type", "client_id", "source_ip"]
      failed_authentications:
        name: "security_failed_authentications_total"
        description: "Failed authentication attempts"
        type: "counter"
        labels: ["client_id", "auth_method", "error_type"]

# Health Check Configuration
health:
  checks:
    dpop:
      enabled: true
      interval: 30s
      timeout: 10s
      checks:
        - name: "dpop_key_validation"
          description: "DPoP key validation functionality"
          critical: true
        - name: "dpop_jti_cache"
          description: "DPoP JTI cache connectivity"
          critical: true
        - name: "dpop_redis_connection"
          description: "Redis connection for DPoP operations"
          critical: true
    
    par:
      enabled: true
      interval: 30s
      timeout: 10s
      checks:
        - name: "par_endpoint"
          description: "PAR endpoint availability"
          critical: true
        - name: "par_cache"
          description: "PAR request cache"
          critical: true
        - name: "par_request_validation"
          description: "PAR request validation"
          critical: false
    
    fapi:
      enabled: true
      interval: 60s
      timeout: 15s
      checks:
        - name: "fapi_compliance"
          description: "FAPI 2.0 compliance check"
          critical: true
        - name: "fapi_headers"
          description: "FAPI header validation"
          critical: false
        - name: "fapi_endpoints"
          description: "FAPI endpoint availability"
          critical: true
    
    oauth2:
      enabled: true
      interval: 30s
      timeout: 10s
      checks:
        - name: "oauth2_token_endpoint"
          description: "OAuth2 token endpoint"
          critical: true
        - name: "oauth2_authorization_endpoint"
          description: "OAuth2 authorization endpoint"
          critical: true
        - name: "oauth2_jwks_endpoint"
          description: "OAuth2 JWKS endpoint"
          critical: true
        - name: "oauth2_keycloak_connectivity"
          description: "Keycloak connectivity"
          critical: true

# Alerting Configuration
alerting:
  enabled: true
  providers:
    - name: "prometheus-alertmanager"
      enabled: true
      url: "http://alertmanager:9093"
    - name: "slack"
      enabled: true
      webhook_url: "${SLACK_WEBHOOK_URL}"
      channel: "#security-alerts"
    - name: "email"
      enabled: true
      smtp_server: "${SMTP_SERVER}"
      recipients: ["security@yourbank.com", "api-team@yourbank.com"]
  
  rules:
    # DPoP Alerts
    dpop_alerts:
      - alert: "DPoPValidationFailureRate"
        expr: "rate(dpop_validation_failure_total[5m]) > 0.1"
        for: "2m"
        severity: "warning"
        description: "DPoP validation failure rate is high"
        labels:
          service: "fapi2-dpop"
          component: "dpop"
      
      - alert: "DPoPReplayAttack"
        expr: "increase(dpop_replay_attacks_total[1m]) > 0"
        for: "0s"
        severity: "critical"
        description: "DPoP replay attack detected"
        labels:
          service: "fapi2-dpop"
          component: "dpop"
      
      - alert: "DPoPValidationLatency"
        expr: "histogram_quantile(0.95, dpop_validation_duration_seconds) > 0.5"
        for: "5m"
        severity: "warning"
        description: "DPoP validation latency is high"
        labels:
          service: "fapi2-dpop"
          component: "dpop"
      
      - alert: "DPoPJTICacheDown"
        expr: "up{job=\"redis-dpop\"} == 0"
        for: "1m"
        severity: "critical"
        description: "DPoP JTI cache is down"
        labels:
          service: "fapi2-dpop"
          component: "redis"
    
    # PAR Alerts
    par_alerts:
      - alert: "PAREndpointDown"
        expr: "up{job=\"par-endpoint\"} == 0"
        for: "1m"
        severity: "critical"
        description: "PAR endpoint is down"
        labels:
          service: "fapi2-dpop"
          component: "par"
      
      - alert: "PARRequestFailureRate"
        expr: "rate(par_request_failure_total[5m]) > 0.05"
        for: "2m"
        severity: "warning"
        description: "PAR request failure rate is high"
        labels:
          service: "fapi2-dpop"
          component: "par"
      
      - alert: "PARCacheSize"
        expr: "par_cache_size > 10000"
        for: "5m"
        severity: "warning"
        description: "PAR cache size is growing too large"
        labels:
          service: "fapi2-dpop"
          component: "par"
    
    # FAPI Alerts
    fapi_alerts:
      - alert: "FAPISecurityViolation"
        expr: "increase(fapi_security_violations_total[1m]) > 0"
        for: "0s"
        severity: "critical"
        description: "FAPI security violation detected"
        labels:
          service: "fapi2-dpop"
          component: "fapi"
      
      - alert: "FAPIHeaderValidationFailures"
        expr: "rate(fapi_header_validation_failures_total[5m]) > 0.1"
        for: "2m"
        severity: "warning"
        description: "FAPI header validation failures are high"
        labels:
          service: "fapi2-dpop"
          component: "fapi"
    
    # OAuth2 Alerts
    oauth2_alerts:
      - alert: "OAuth2TokenEndpointDown"
        expr: "up{job=\"oauth2-token\"} == 0"
        for: "1m"
        severity: "critical"
        description: "OAuth2 token endpoint is down"
        labels:
          service: "fapi2-dpop"
          component: "oauth2"
      
      - alert: "OAuth2AuthenticationFailures"
        expr: "rate(oauth2_client_authentication_failures_total[5m]) > 0.1"
        for: "2m"
        severity: "warning"
        description: "OAuth2 client authentication failures are high"
        labels:
          service: "fapi2-dpop"
          component: "oauth2"
    
    # Security Alerts
    security_alerts:
      - alert: "RateLimitingTriggered"
        expr: "increase(security_rate_limiting_triggered_total[1m]) > 10"
        for: "1m"
        severity: "warning"
        description: "Rate limiting triggered frequently"
        labels:
          service: "fapi2-dpop"
          component: "security"
      
      - alert: "SuspiciousActivity"
        expr: "increase(security_suspicious_activity_total[1m]) > 0"
        for: "0s"
        severity: "critical"
        description: "Suspicious security activity detected"
        labels:
          service: "fapi2-dpop"
          component: "security"

# Dashboards Configuration
dashboards:
  grafana:
    enabled: true
    url: "http://grafana:3000"
    dashboards:
      - name: "FAPI 2.0 + DPoP Overview"
        file: "fapi2-dpop-overview.json"
        folder: "Security"
      - name: "DPoP Validation Metrics"
        file: "dpop-validation-metrics.json"
        folder: "Security"
      - name: "PAR Performance"
        file: "par-performance.json"
        folder: "OAuth2"
      - name: "OAuth2 Security"
        file: "oauth2-security.json"
        folder: "OAuth2"
      - name: "FAPI Compliance"
        file: "fapi-compliance.json"
        folder: "Compliance"

# Logging Configuration for Monitoring
logging:
  structured: true
  format: "json"
  level: "INFO"
  
  # Security event logging
  security_events:
    enabled: true
    log_level: "WARN"
    include_headers: true
    include_client_info: true
    events:
      - "dpop_validation_failure"
      - "dpop_replay_attack"
      - "fapi_security_violation"
      - "oauth2_authentication_failure"
      - "rate_limiting_triggered"
      - "suspicious_activity"
  
  # Audit logging
  audit:
    enabled: true
    log_level: "INFO"
    include_request_details: true
    events:
      - "dpop_proof_validation"
      - "par_request_processing"
      - "token_issuance"
      - "client_authentication"
      - "api_access"
  
  # Performance logging
  performance:
    enabled: true
    log_level: "DEBUG"
    slow_request_threshold: 1000ms
    include_timing_details: true

# Tracing Configuration
tracing:
  enabled: true
  service_name: "fapi2-dpop-banking"
  jaeger:
    enabled: true
    endpoint: "http://jaeger:14268/api/traces"
    sampler:
      type: "probabilistic"
      param: 0.1
  
  # Span configuration
  spans:
    dpop_validation:
      enabled: true
      include_proof_details: false  # Security: don't log sensitive data
    par_processing:
      enabled: true
      include_request_details: true
    oauth2_operations:
      enabled: true
      include_token_details: false  # Security: don't log tokens
    fapi_validation:
      enabled: true
      include_header_details: true

# Custom Health Indicators
custom_health_indicators:
  - name: "DPoPValidationHealthIndicator"
    class: "com.bank.loan.loan.security.dpop.health.DPoPValidationHealthIndicator"
    enabled: true
    
  - name: "PAREndpointHealthIndicator"
    class: "com.bank.loan.loan.security.par.health.PAREndpointHealthIndicator"
    enabled: true
    
  - name: "FAPIComplianceHealthIndicator"
    class: "com.bank.loan.loan.security.fapi.health.FAPIComplianceHealthIndicator"
    enabled: true
    
  - name: "OAuth2SecurityHealthIndicator"
    class: "com.bank.loan.loan.security.oauth2.health.OAuth2SecurityHealthIndicator"
    enabled: true

# SLA Configuration
sla:
  targets:
    dpop_validation:
      p95_latency: 100ms
      p99_latency: 200ms
      availability: 99.9%
    par_processing:
      p95_latency: 200ms
      p99_latency: 500ms
      availability: 99.95%
    oauth2_operations:
      p95_latency: 500ms
      p99_latency: 1000ms
      availability: 99.99%
    fapi_compliance:
      availability: 99.99%
      violation_rate: 0.001%

# Capacity Planning
capacity:
  thresholds:
    dpop_validations_per_second: 1000
    par_requests_per_second: 500
    concurrent_connections: 10000
    memory_usage: 80%
    cpu_usage: 70%
  
  scaling:
    auto_scaling:
      enabled: true
      min_instances: 2
      max_instances: 10
      target_cpu_utilization: 70%
      target_memory_utilization: 80%