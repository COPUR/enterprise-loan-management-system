plugins {
    id 'java-library'
    id 'org.springframework.boot' apply false
    id 'io.spring.dependency-management'
}

description = 'Open Finance Application - Use cases and application services for Open Finance'

sourceSets {
    main {
        java.setSrcDirs([])
    }
    test {
        java.setSrcDirs([])
    }
}

dependencyManagement {
    imports {
        mavenBom 'org.springframework.boot:spring-boot-dependencies:3.3.6'
    }
}

dependencies {
    // Domain dependency
    api project(':open-finance-context:open-finance-domain')
    api project(':shared-kernel')
    api project(':shared-infrastructure')
    
    // Application layer dependencies
    api 'org.springframework:spring-context'
    api 'org.springframework:spring-tx'
    api 'org.springframework.boot:spring-boot-starter-validation'
    
    // Saga and event handling
    implementation 'org.springframework.kafka:spring-kafka'
    implementation 'org.springframework.statemachine:spring-statemachine-core:4.0.1'
    
    // Mapping
    implementation libs.mapstruct
    annotationProcessor libs.mapstruct.processor
    
    // Lombok
    compileOnly libs.lombok
    annotationProcessor libs.lombok
    
    // Jackson for serialization
    implementation 'com.fasterxml.jackson.core:jackson-databind'
    implementation 'com.fasterxml.jackson.datatype:jackson-datatype-jsr310'
    
    // Validation
    implementation 'jakarta.validation:jakarta.validation-api'
    implementation 'org.hibernate.validator:hibernate-validator'
    
    // Testing - Following project's TDD approach
    testImplementation libs.junit.jupiter
    testImplementation libs.assertj.core
    testImplementation libs.mockito.junit.jupiter
    testImplementation libs.mockito.core
    testImplementation libs.jqwik
    testImplementation 'org.springframework:spring-test'
    testImplementation 'org.springframework.boot:spring-boot-test'
    testImplementation libs.archunit.junit5
    testImplementation libs.awaitility
    
    // TestContainers for integration testing
    testImplementation 'org.testcontainers:junit-jupiter'
    testImplementation 'org.testcontainers:kafka'
    testImplementation 'org.testcontainers:postgresql'
}

test {
    useJUnitPlatform {
        includeEngines 'junit-jupiter', 'jqwik'
    }
    systemProperty 'spring.profiles.active', 'test'
    maxParallelForks = Runtime.runtime.availableProcessors().intdiv(2) ?: 1
}

// TDD-focused architecture testing
tasks.register('archTest', Test) {
    useJUnitPlatform {
        includeTags 'architecture'
    }
    systemProperty 'archunit.freeze.store.default.path', 'build/archunit'
}

// Property-based testing task
tasks.register('propertyTest', Test) {
    useJUnitPlatform {
        includeTags 'property-based'
    }
    systemProperty 'jqwik.tries.default', '100'
    systemProperty 'jqwik.reporting.usejunitplatform', 'true'
}

check.dependsOn archTest, propertyTest
