plugins {
    id 'java-library'
    id 'jacoco'
    id 'org.springframework.boot' apply false
    id 'io.spring.dependency-management'
}

description = 'Open Finance Application - Use cases and application services for Open Finance'

sourceSets {
    main {
        java {
            setSrcDirs(['src/main/java'])
            include 'com/enterprise/openfinance/uc01/**'
            include 'com/enterprise/openfinance/uc02/**'
            include 'com/enterprise/openfinance/uc03/**'
            include 'com/enterprise/openfinance/uc04/**'
            include 'com/enterprise/openfinance/uc05/**'
            include 'com/enterprise/openfinance/uc06/**'
            include 'com/enterprise/openfinance/uc07/**'
            include 'com/enterprise/openfinance/uc08/**'
            include 'com/enterprise/openfinance/uc09/**'
            include 'com/enterprise/openfinance/uc10/**'
            include 'com/enterprise/openfinance/uc11/**'
            include 'com/enterprise/openfinance/uc12/**'
            include 'com/enterprise/openfinance/uc14/**'
        }
    }
    test {
        java {
            setSrcDirs(['src/test/java'])
            include 'com/enterprise/openfinance/uc01/**'
            include 'com/enterprise/openfinance/uc02/**'
            include 'com/enterprise/openfinance/uc03/**'
            include 'com/enterprise/openfinance/uc04/**'
            include 'com/enterprise/openfinance/uc05/**'
            include 'com/enterprise/openfinance/uc06/**'
            include 'com/enterprise/openfinance/uc07/**'
            include 'com/enterprise/openfinance/uc08/**'
            include 'com/enterprise/openfinance/uc09/**'
            include 'com/enterprise/openfinance/uc10/**'
            include 'com/enterprise/openfinance/uc11/**'
            include 'com/enterprise/openfinance/uc12/**'
            include 'com/enterprise/openfinance/uc14/**'
        }
    }
}

dependencyManagement {
    imports {
        mavenBom 'org.springframework.boot:spring-boot-dependencies:3.3.6'
    }
}

dependencies {
    // Domain dependency
    api project(':open-finance-context:open-finance-domain')
    api project(':shared-kernel')
    api project(':shared-infrastructure')
    
    // Application layer dependencies
    api 'org.springframework:spring-context'
    api 'org.springframework:spring-tx'
    api 'org.springframework.boot:spring-boot-starter-validation'
    
    // Saga and event handling
    implementation 'org.springframework.kafka:spring-kafka'
    implementation 'org.springframework.statemachine:spring-statemachine-core:4.0.1'
    
    // Mapping
    implementation libs.mapstruct
    annotationProcessor libs.mapstruct.processor
    
    // Lombok
    compileOnly libs.lombok
    annotationProcessor libs.lombok
    
    // Jackson for serialization
    implementation 'com.fasterxml.jackson.core:jackson-databind'
    implementation 'com.fasterxml.jackson.datatype:jackson-datatype-jsr310'
    
    // Validation
    implementation 'jakarta.validation:jakarta.validation-api'
    implementation 'org.hibernate.validator:hibernate-validator'
    
    // Testing - Following project's TDD approach
    testImplementation libs.junit.jupiter
    testImplementation libs.assertj.core
    testImplementation libs.mockito.junit.jupiter
    testImplementation libs.mockito.core
    testImplementation libs.jqwik
    testImplementation 'org.springframework:spring-test'
    testImplementation 'org.springframework.boot:spring-boot-test'
    testImplementation libs.archunit.junit5
    testImplementation libs.awaitility
    
    // TestContainers for integration testing
    testImplementation 'org.testcontainers:junit-jupiter'
    testImplementation 'org.testcontainers:kafka'
    testImplementation 'org.testcontainers:postgresql'
}

test {
    useJUnitPlatform {
        includeEngines 'junit-jupiter', 'jqwik'
    }
    systemProperty 'spring.profiles.active', 'test'
    maxParallelForks = Runtime.runtime.availableProcessors().intdiv(2) ?: 1
}

jacoco {
    toolVersion = '0.8.14'
}

jacocoTestReport {
    dependsOn test
    reports {
        xml.required = true
        html.required = true
    }
    classDirectories.setFrom(files(classDirectories.files.collect { dir ->
        fileTree(
                dir: dir,
                include: [
                        'com/enterprise/openfinance/uc01/**',
                        'com/enterprise/openfinance/uc02/**',
                        'com/enterprise/openfinance/uc03/**',
                        'com/enterprise/openfinance/uc04/**',
                        'com/enterprise/openfinance/uc05/**',
                        'com/enterprise/openfinance/uc06/**',
                        'com/enterprise/openfinance/uc07/**',
                        'com/enterprise/openfinance/uc08/**',
                        'com/enterprise/openfinance/uc09/**',
                        'com/enterprise/openfinance/uc10/**',
                        'com/enterprise/openfinance/uc11/**',
                        'com/enterprise/openfinance/uc12/**',
                        'com/enterprise/openfinance/uc14/**'
                ]
        )
    }))
}

jacocoTestCoverageVerification {
    dependsOn jacocoTestReport
    violationRules {
        rule {
            limit {
                counter = 'LINE'
                value = 'COVEREDRATIO'
                minimum = 0.85
            }
        }
    }
}

// TDD-focused architecture testing
tasks.register('archTest', Test) {
    useJUnitPlatform {
        includeTags 'architecture'
    }
    systemProperty 'archunit.freeze.store.default.path', 'build/archunit'
}

// Property-based testing task
tasks.register('propertyTest', Test) {
    useJUnitPlatform {
        includeTags 'property-based'
    }
    systemProperty 'jqwik.tries.default', '100'
    systemProperty 'jqwik.reporting.usejunitplatform', 'true'
}

check.dependsOn archTest, propertyTest
check.dependsOn jacocoTestCoverageVerification
