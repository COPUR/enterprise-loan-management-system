plugins {
    id 'java-library'
    id 'jacoco'
    id 'org.springframework.boot' apply false
    id 'io.spring.dependency-management'
}

description = 'Open Finance Domain - Core business logic for Open Finance integration'

sourceSets {
    main {
        java {
            setSrcDirs(['src/main/java'])
            include 'com/enterprise/openfinance/uc01/**'
            include 'com/enterprise/openfinance/uc02/**'
            include 'com/enterprise/openfinance/uc03/**'
            include 'com/enterprise/openfinance/uc04/**'
            include 'com/enterprise/openfinance/uc05/**'
            include 'com/enterprise/openfinance/uc06/**'
            include 'com/enterprise/openfinance/uc07/**'
            include 'com/enterprise/openfinance/uc08/**'
            include 'com/enterprise/openfinance/uc09/**'
            include 'com/enterprise/openfinance/uc10/**'
            include 'com/enterprise/openfinance/uc11/**'
            include 'com/enterprise/openfinance/uc12/**'
            include 'com/enterprise/openfinance/uc14/**'
        }
    }
    test {
        java {
            setSrcDirs(['src/test/java'])
            include 'com/enterprise/openfinance/uc01/**'
            include 'com/enterprise/openfinance/uc02/**'
            include 'com/enterprise/openfinance/uc03/**'
            include 'com/enterprise/openfinance/uc04/**'
            include 'com/enterprise/openfinance/uc05/**'
            include 'com/enterprise/openfinance/uc06/**'
            include 'com/enterprise/openfinance/uc07/**'
            include 'com/enterprise/openfinance/uc08/**'
            include 'com/enterprise/openfinance/uc09/**'
            include 'com/enterprise/openfinance/uc10/**'
            include 'com/enterprise/openfinance/uc11/**'
            include 'com/enterprise/openfinance/uc12/**'
            include 'com/enterprise/openfinance/uc14/**'
        }
    }
}

dependencies {
    // Domain model dependencies
    api project(':common:common-domain')
    
    // Domain event support
    api 'org.springframework:spring-context:6.1.0'
    api 'org.springframework:spring-tx:6.1.0'
    
    // Value object support
    compileOnly libs.lombok
    annotationProcessor libs.lombok
    
    // Validation
    api 'jakarta.validation:jakarta.validation-api:3.0.2'
    implementation libs.hibernate.validator
    
    // Jackson for JSON serialization
    api libs.jackson.annotations
    implementation libs.jackson.databind
    implementation libs.jackson.datatype.jsr310
    
    // Testing
    testImplementation project(':common:common-test')
    testImplementation libs.junit.jupiter
    testImplementation libs.assertj.core
    testImplementation libs.mockito.junit.jupiter
    testImplementation libs.archunit.junit5
    testImplementation libs.jqwik
}

test {
    useJUnitPlatform {
        includeEngines 'junit-jupiter', 'jqwik'
    }
}

jacoco {
    toolVersion = '0.8.14'
}

jacocoTestReport {
    dependsOn test
    reports {
        xml.required = true
        html.required = true
    }
    classDirectories.setFrom(files(classDirectories.files.collect { dir ->
        fileTree(
                dir: dir,
                include: [
                        'com/enterprise/openfinance/uc01/**',
                        'com/enterprise/openfinance/uc02/**',
                        'com/enterprise/openfinance/uc03/**',
                        'com/enterprise/openfinance/uc04/**',
                        'com/enterprise/openfinance/uc05/**',
                        'com/enterprise/openfinance/uc06/**',
                        'com/enterprise/openfinance/uc07/**',
                        'com/enterprise/openfinance/uc08/**',
                        'com/enterprise/openfinance/uc09/**',
                        'com/enterprise/openfinance/uc10/**',
                        'com/enterprise/openfinance/uc11/**',
                        'com/enterprise/openfinance/uc12/**',
                        'com/enterprise/openfinance/uc14/**'
                ]
        )
    }))
}

jacocoTestCoverageVerification {
    dependsOn jacocoTestReport
    violationRules {
        rule {
            limit {
                counter = 'LINE'
                value = 'COVEREDRATIO'
                minimum = 0.85
            }
        }
    }
}

// Enforce architectural rules
tasks.register('archTest', Test) {
    useJUnitPlatform {
        includeTags 'architecture'
    }
}

check.dependsOn archTest
check.dependsOn jacocoTestCoverageVerification
