@startuml Enhanced Enterprise Banking - Service Mesh Architecture
!theme plain

title Enhanced Enterprise Banking System\nIstio Service Mesh with Event-Driven Architecture

package "Client Applications" {
  [Mobile Banking App] as Mobile
  [Web Banking Portal] as Web
  [Third Party Apps] as TPP
  [Admin Dashboard] as Admin
}

package "Istio Service Mesh" {
  package "Ingress Gateway" {
    [Istio Ingress Gateway] as IngressGW
    [Load Balancer] as LB
  }
  
  package "Service Mesh Control Plane" {
    [Pilot] as Pilot
    [Citadel] as Citadel
    [Galley] as Galley
    [Mixer] as Mixer
  }
  
  package "Data Plane (Envoy Sidecars)" {
    [Loan Service Envoy] as LoanEnvoy
    [Customer Service Envoy] as CustomerEnvoy
    [Payment Service Envoy] as PaymentEnvoy
    [AI Service Envoy] as AIEnvoy
    [Compliance Service Envoy] as ComplianceEnvoy
    [Fraud Service Envoy] as FraudEnvoy
  }
}

package "Banking Microservices" {
  [Loan Management Service] as LoanSvc
  [Customer Management Service] as CustomerSvc
  [Payment Processing Service] as PaymentSvc
  [AI Risk Assessment Service] as AISvc
  [Compliance Service] as ComplianceSvc
  [Fraud Detection Service] as FraudSvc
}

package "Event-Driven Communication" {
  [Kafka Event Streaming] as Kafka
  [Event Schema Registry] as SchemaRegistry
  [Dead Letter Queue] as DLQ
  
  package "Banking Event Topics" {
    [Loan Domain Events] as LoanEvents
    [Customer Lifecycle Events] as CustomerEvents
    [Payment Transaction Events] as PaymentEvents
    [AI Insights Events] as AIEvents
    [Compliance Events] as ComplianceEvents
    [Fraud Alert Events] as FraudEvents
  }
}

package "Data & Infrastructure" {
  [PostgreSQL Cluster] as PgCluster
  [Redis Cluster] as RedisCluster
  [Qdrant Vector DB] as VectorDB
  [OAuth2.1 Server] as OAuth2
  [Monitoring Stack] as Monitoring
}

package "Security & Compliance" {
  [FAPI Token Management] as FAPITokens
  [mTLS Certificate Manager] as mTLS
  [RBAC Policy Engine] as RBAC
  [Audit Logging] as AuditLog
  [Rate Limiting] as RateLimit
}

' Client connections
Mobile --> IngressGW : HTTPS/TLS 1.3
Web --> IngressGW : HTTPS/TLS 1.3
TPP --> IngressGW : FAPI OAuth2.1
Admin --> IngressGW : Admin Access

' Ingress Gateway
IngressGW --> LB : Load Distribution
LB --> LoanEnvoy : Service Routing
LB --> CustomerEnvoy : Service Routing
LB --> PaymentEnvoy : Service Routing
LB --> AIEnvoy : Service Routing

' Control Plane
Pilot --> LoanEnvoy : Traffic Management
Pilot --> CustomerEnvoy : Service Discovery
Pilot --> PaymentEnvoy : Load Balancing
Pilot --> AIEnvoy : Circuit Breaking

Citadel --> mTLS : Certificate Management
Citadel --> LoanEnvoy : Identity & Security
Citadel --> CustomerEnvoy : mTLS Certificates
Citadel --> PaymentEnvoy : Zero-Trust Security

Galley --> Pilot : Configuration Validation
Mixer --> Monitoring : Telemetry Collection

' Envoy to Services
LoanEnvoy -.-> LoanSvc : Sidecar Proxy
CustomerEnvoy -.-> CustomerSvc : Sidecar Proxy
PaymentEnvoy -.-> PaymentSvc : Sidecar Proxy
AIEnvoy -.-> AISvc : Sidecar Proxy
ComplianceEnvoy -.-> ComplianceSvc : Sidecar Proxy
FraudEnvoy -.-> FraudSvc : Sidecar Proxy

' Event-Driven Communication
LoanSvc --> LoanEvents : Publish Events
CustomerSvc --> CustomerEvents : Publish Events
PaymentSvc --> PaymentEvents : Publish Events
AISvc --> AIEvents : Publish Events
ComplianceSvc --> ComplianceEvents : Publish Events
FraudSvc --> FraudEvents : Publish Events

LoanEvents --> Kafka : Event Streaming
CustomerEvents --> Kafka : Event Streaming
PaymentEvents --> Kafka : Event Streaming
AIEvents --> Kafka : Event Streaming
ComplianceEvents --> Kafka : Event Streaming
FraudEvents --> Kafka : Event Streaming

Kafka --> SchemaRegistry : Schema Validation
Kafka --> DLQ : Failed Message Handling

' Cross-Service Event Consumption
CustomerEvents --> LoanSvc : Customer Updates
PaymentEvents --> LoanSvc : Payment Updates
AIEvents --> LoanSvc : AI Insights
FraudEvents --> LoanSvc : Fraud Alerts
ComplianceEvents --> LoanSvc : Compliance Status

LoanEvents --> CustomerSvc : Loan Updates
LoanEvents --> PaymentSvc : Payment Scheduling
LoanEvents --> AISvc : AI Analysis
LoanEvents --> ComplianceSvc : Compliance Monitoring

' Data Access
LoanSvc --> PgCluster : Loan Data
CustomerSvc --> PgCluster : Customer Data
PaymentSvc --> PgCluster : Payment Data
AISvc --> VectorDB : AI Embeddings
ComplianceSvc --> PgCluster : Compliance Data
FraudSvc --> RedisCluster : Real-time Cache

' Security Integration
IngressGW --> FAPITokens : Token Validation
IngressGW --> OAuth2 : Authentication
IngressGW --> RBAC : Authorization
IngressGW --> RateLimit : Rate Limiting

LoanEnvoy --> mTLS : Service-to-Service Security
CustomerEnvoy --> mTLS : Certificate Validation
PaymentEnvoy --> mTLS : Zero-Trust Communication

LoanSvc --> AuditLog : Audit Trail
CustomerSvc --> AuditLog : Customer Audit
PaymentSvc --> AuditLog : Payment Audit
ComplianceSvc --> AuditLog : Compliance Audit
FraudSvc --> AuditLog : Security Audit

' Monitoring & Observability
LoanEnvoy --> Monitoring : Service Metrics
CustomerEnvoy --> Monitoring : Health Checks
PaymentEnvoy --> Monitoring : Performance Metrics
AIEnvoy --> Monitoring : AI Model Metrics
ComplianceEnvoy --> Monitoring : Compliance Metrics
FraudEnvoy --> Monitoring : Security Metrics

note right of Kafka : Event-Driven Architecture\n- Asynchronous Communication\n- Event Sourcing\n- SAGA Pattern\n- Eventual Consistency\n- Domain Events

note left of Pilot : Service Mesh Benefits\n- Traffic Management\n- Security Policies\n- Observability\n- Resilience Patterns\n- Zero-Trust Networking

note bottom of mTLS : Security Features\n- End-to-End Encryption\n- Certificate Rotation\n- Identity Verification\n- Zero-Trust Architecture\n- FAPI Compliance

@enduml