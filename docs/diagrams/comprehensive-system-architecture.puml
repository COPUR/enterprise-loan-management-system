@startuml Comprehensive System Architecture - Enterprise Loan Management System

!theme aws-orange
!define RECTANGLE_STYLE(name) rectangle name as name##_rect
skinparam backgroundColor #FFFFFF
skinparam defaultFontName "Arial"
skinparam defaultFontSize 10

title "Enterprise Loan Management System - Comprehensive Architecture\nFAPI 2.0 + DPoP Security Profile | Production-Ready Banking Platform"

' Define color schemes
!define SECURITY_COLOR #FF6B35
!define DOMAIN_COLOR #2E8B57
!define INFRASTRUCTURE_COLOR #4169E1
!define APPLICATION_COLOR #9932CC
!define DATA_COLOR #DC143C

' External Systems
package "External Systems" as external #F0F0F0 {
  actor "Banking Customer" as customer
  actor "Loan Officer" as officer
  actor "Underwriter" as underwriter
  
  cloud "Keycloak\nFAPI 2.0 + DPoP" as keycloak #SECURITY_COLOR
  cloud "External APIs\n(Credit Bureau)" as external_apis
  cloud "Payment Gateway" as payment_gateway
}

' API Gateway & Security Layer
package "API Gateway & Security" as gateway #SECURITY_COLOR {
  rectangle "Istio Service Mesh\nZero-Trust Security" as istio
  rectangle "FAPI 2.0 Security\nValidation" as fapi_validation
  rectangle "DPoP Validation\n(RFC 9449)" as dpop_validation
  rectangle "PAR Endpoint\n(Pushed Auth Requests)" as par_endpoint
  rectangle "Rate Limiting &\nThreat Protection" as rate_limiting
}

' Application Layer
package "Application Layer" as app_layer #APPLICATION_COLOR {
  
  ' Core Controllers
  package "FAPI 2.0 Secured Controllers" as controllers {
    rectangle "SecureLoanController\n@DPoPSecured @FAPISecured" as loan_controller
    rectangle "AIAssistantRestController\n@DPoPSecured @FAPISecured" as ai_controller
    rectangle "OAuth2 Controllers\nFAPI 2.0 Compliant" as oauth_controller
    rectangle "Payment Controller\nBanking Compliance" as payment_controller
  }
  
  ' Application Services
  package "Application Services" as app_services {
    rectangle "LoanService\nBusiness Logic" as loan_service
    rectangle "PaymentService\nFDCPA Waterfall" as payment_service
    rectangle "AuditService\nRegulatory Compliance" as audit_service
    rectangle "IdempotencyService\nFinancial Safety" as idempotency_service
    rectangle "AIAssistantService\nML Banking Analysis" as ai_service
  }
}

' Domain Layer
package "Domain Layer (DDD)" as domain_layer #DOMAIN_COLOR {
  
  package "Loan Bounded Context" as loan_context {
    rectangle "Loan Aggregate\nLoan, LoanInstallment" as loan_aggregate
    rectangle "Loan Domain Services\nBusiness Rules" as loan_domain_services
    rectangle "Loan Events\nLoanCreated, LoanApproved" as loan_events
  }
  
  package "Customer Bounded Context" as customer_context {
    rectangle "Customer Aggregate\nCustomer, CreditScore" as customer_aggregate
    rectangle "Customer Events\nCreditReleased, CreditReserved" as customer_events
  }
  
  package "Payment Bounded Context" as payment_context {
    rectangle "Payment Aggregate\nPayment, PaymentMethod" as payment_aggregate
    rectangle "Payment Domain Services\nWaterfall Allocation" as payment_domain_services
    rectangle "Payment Events\nPaymentProcessed" as payment_events
  }
  
  package "AI Bounded Context" as ai_context {
    rectangle "AI Domain Models\nAnalysis, Risk Assessment" as ai_domain
    rectangle "AI Services\nNLP, Risk Analysis" as ai_domain_services
  }
}

' Infrastructure Layer
package "Infrastructure Layer" as infra_layer #INFRASTRUCTURE_COLOR {
  
  package "Security Infrastructure" as security_infra {
    rectangle "DPoP Validation Service\nJTI Replay Prevention" as dpop_service
    rectangle "FAPI Security Interceptors\nAutomatic Validation" as fapi_interceptors
    rectangle "Security Event Logger\nAudit Trail" as security_logger
  }
  
  package "Persistence Layer" as persistence {
    rectangle "JPA Repositories\nHibernate ORM" as jpa_repos
    rectangle "Transaction Management\nACID Compliance" as transaction_mgmt
    rectangle "Database Migrations\nLiquibase" as migrations
  }
  
  package "Messaging Infrastructure" as messaging {
    rectangle "Kafka Event Streaming\nDomain Events" as kafka
    rectangle "Event Handlers\nAsynchronous Processing" as event_handlers
  }
  
  package "Caching Layer" as caching {
    rectangle "Redis Cache\nDPoP JTI Storage" as redis_cache
    rectangle "Second Level Cache\nHibernate Cache" as hibernate_cache
  }
}

' Data Layer
package "Data Layer" as data_layer #DATA_COLOR {
  database "PostgreSQL\nPrimary Database\nBanking Grade" as postgres
  database "Redis\nDPoP JTI & Nonce\nCache Storage" as redis
  database "Kafka Topics\nEvent Streaming\nDomain Events" as kafka_topics
}

' Monitoring & Observability
package "Monitoring & Observability" as monitoring #FFA500 {
  rectangle "Prometheus\nMetrics Collection" as prometheus
  rectangle "Grafana\nBanking Dashboards" as grafana
  rectangle "ELK Stack\nCentralized Logging" as elk
  rectangle "Distributed Tracing\nJaeger" as jaeger
  rectangle "Custom FAPI Metrics\nSecurity Monitoring" as fapi_metrics
}

' AI/ML Infrastructure
package "AI/ML Infrastructure" as ai_infra #9370DB {
  rectangle "OpenAI Integration\nGPT-4 Banking" as openai
  rectangle "Risk Assessment Models\nML Pipeline" as risk_models
  rectangle "NLP Processing\nCustomer Intent" as nlp
}

' Compliance & Audit
package "Compliance Framework" as compliance #8B0000 {
  rectangle "FDCPA Compliance\nPayment Waterfall" as fdcpa
  rectangle "TILA Compliance\nTruth in Lending" as tila
  rectangle "RESPA Compliance\nSettlement Procedures" as respa
  rectangle "PCI DSS\nPayment Security" as pci_dss
  rectangle "Audit Trail\nRegulatory Reporting" as audit_trail
}

' Relationships - External to Gateway
customer --> istio : "HTTPS/TLS 1.3\nFAPI 2.0 Headers"
officer --> istio : "Banking Portal\nDPoP Authentication"
underwriter --> istio : "Risk Assessment\nSecure Access"

keycloak --> par_endpoint : "OAuth 2.1\nPrivate Key JWT"
keycloak --> dpop_validation : "DPoP Validation\nJTI Management"

' Gateway Internal Flow
istio --> fapi_validation : "FAPI Headers\nValidation"
fapi_validation --> dpop_validation : "DPoP Proof\nVerification"
dpop_validation --> rate_limiting : "Security\nValidation"
rate_limiting --> par_endpoint : "Authorization\nRequests"

' Gateway to Controllers
par_endpoint --> oauth_controller : "Authorized\nRequests"
rate_limiting --> loan_controller : "Validated\nRequests"
rate_limiting --> ai_controller : "AI Analysis\nRequests"
rate_limiting --> payment_controller : "Payment\nProcessing"

' Controllers to Services
loan_controller --> loan_service : "Business\nOperations"
loan_controller --> audit_service : "Compliance\nLogging"
loan_controller --> idempotency_service : "Duplicate\nPrevention"

ai_controller --> ai_service : "AI Analysis\nRequests"
payment_controller --> payment_service : "Payment\nProcessing"

' Application Services to Domain
loan_service --> loan_aggregate : "Domain\nOperations"
loan_service --> loan_domain_services : "Business\nRules"
payment_service --> payment_aggregate : "Payment\nOperations"
payment_service --> payment_domain_services : "Waterfall\nAllocation"
ai_service --> ai_domain : "AI\nAnalysis"

' Domain Events
loan_aggregate --> loan_events : "Domain\nEvents"
customer_aggregate --> customer_events : "Customer\nEvents"
payment_aggregate --> payment_events : "Payment\nEvents"

' Infrastructure Services
fapi_interceptors --> security_logger : "Security\nEvents"
dpop_service --> redis_cache : "JTI\nStorage"
loan_events --> kafka : "Event\nPublishing"
customer_events --> kafka : "Event\nStreaming"

' Data Access
jpa_repos --> postgres : "JDBC\nConnections"
redis_cache --> redis : "Cache\nOperations"
kafka --> kafka_topics : "Message\nStreaming"

' Monitoring Connections
loan_service --> prometheus : "Business\nMetrics"
dpop_service --> fapi_metrics : "Security\nMetrics"
security_logger --> elk : "Audit\nLogs"
istio --> jaeger : "Distributed\nTracing"

' AI Connections
ai_service --> openai : "GPT-4\nIntegration"
ai_service --> risk_models : "Risk\nAssessment"
ai_service --> nlp : "NLP\nProcessing"

' Compliance Connections
payment_service --> fdcpa : "Payment\nCompliance"
audit_service --> tila : "Lending\nCompliance"
audit_service --> respa : "Settlement\nCompliance"
payment_controller --> pci_dss : "Payment\nSecurity"
audit_service --> audit_trail : "Regulatory\nReporting"

' External System Connections
external_apis --> loan_service : "Credit Bureau\nIntegration"
payment_gateway --> payment_service : "Payment\nProcessing"

' Notes
note top of keycloak : "FAPI 2.0 Realm\nDPoP Support\nPrivate Key JWT"
note top of dpop_validation : "RFC 9449 Compliant\nJTI Replay Prevention\nCryptographic Binding"
note top of loan_aggregate : "Banking Domain\nRegulatory Compliance\nEvent Sourcing"
note top of postgres : "ACID Transactions\nBanking Grade\nEncryption at Rest"

@enduml