@startuml FAPI 2.0 + DPoP Security Architecture

!theme aws-orange
skinparam backgroundColor #FFFFFF
skinparam defaultFontName "Arial"
skinparam defaultFontSize 10

title "FAPI 2.0 + DPoP Security Architecture\nRFC 9449 Compliant | Banking-Grade Security Implementation"

' Define colors
!define SECURITY_CRITICAL #FF4444
!define SECURITY_HIGH #FF8800
!define SECURITY_MEDIUM #FFBB00
!define SECURITY_LOW #88DD44
!define DATA_FLOW #4444FF

' Client Side
package "Client Application" as client #F0F8FF {
  rectangle "Banking Web App\nSPA/Mobile" as webapp
  rectangle "DPoP Key Pair\nES256/RS256" as dpop_keys
  rectangle "DPoP Client Library\nProof Generation" as dpop_client
  rectangle "PKCE Implementation\nCode Challenge" as pkce_client
}

' Keycloak FAPI 2.0 Realm
package "Keycloak FAPI 2.0 Identity Provider" as keycloak_realm #SECURITY_CRITICAL {
  rectangle "FAPI 2.0 Realm\nbanking-fapi2" as fapi_realm
  rectangle "Private Key JWT\nClient Authentication" as private_key_jwt
  rectangle "DPoP Support\nToken Binding" as keycloak_dpop
  rectangle "PAR Endpoint\n/ext/par" as keycloak_par
}

' API Gateway Security Layer
package "API Gateway Security" as gateway_security #SECURITY_HIGH {
  rectangle "Istio Ingress\nTLS Termination" as istio_ingress
  rectangle "Rate Limiting\n100 req/min" as rate_limiting
  rectangle "CORS Configuration\nFAPI Headers" as cors_config
  rectangle "Security Headers\nValidation" as security_headers
}

' FAPI 2.0 Security Components
package "FAPI 2.0 Security Layer" as fapi_security #SECURITY_HIGH {
  rectangle "PAR Controller\n/oauth2/par" as par_controller
  rectangle "Authorization Controller\n/oauth2/authorize" as auth_controller
  rectangle "Token Controller\n/oauth2/token" as token_controller
  rectangle "FAPI Security Interceptor\nAutomatic Validation" as fapi_interceptor
}

' DPoP Security Components
package "DPoP Security Layer (RFC 9449)" as dpop_security #SECURITY_CRITICAL {
  rectangle "DPoP Validation Filter\nRequest Interception" as dpop_filter
  rectangle "DPoP Proof Validator\nRFC 9449 Compliance" as dpop_validator
  rectangle "JTI Replay Prevention\nRedis Storage" as jti_prevention
  rectangle "Nonce Management\nEnhanced Security" as nonce_mgmt
  rectangle "Access Token Binding\ncnf Claim Validation" as token_binding
}

' Application Security
package "Application Security" as app_security #SECURITY_MEDIUM {
  rectangle "Security Annotations\n@DPoPSecured @FAPISecured" as security_annotations
  rectangle "Method-Level Security\n@PreAuthorize" as method_security
  rectangle "Audit Service\nCompliance Logging" as audit_service
  rectangle "Idempotency Service\nFinancial Safety" as idempotency
}

' Secure Controllers
package "Secured Banking Controllers" as controllers #SECURITY_MEDIUM {
  rectangle "SecureLoanController\nFAPI + DPoP" as loan_controller
  rectangle "PaymentController\nBanking Compliance" as payment_controller
  rectangle "AIAssistantController\nSecured AI" as ai_controller
}

' Data Security
package "Data Security Layer" as data_security #SECURITY_HIGH {
  rectangle "PostgreSQL\nEncryption at Rest" as postgres_security
  rectangle "Redis Security\nDPoP JTI Storage" as redis_security
  rectangle "Kafka Security\nEncrypted Messaging" as kafka_security
}

' Monitoring & Audit
package "Security Monitoring" as monitoring #SECURITY_LOW {
  rectangle "FAPI Metrics\nSecurity Events" as fapi_metrics
  rectangle "DPoP Metrics\nValidation Stats" as dpop_metrics
  rectangle "Audit Logs\nELK Stack" as audit_logs
  rectangle "Security Alerts\nPrometheus" as security_alerts
}

' External Security Services
cloud "Credit Bureau\nmTLS" as credit_bureau
cloud "Payment Gateway\nPCI DSS" as payment_gateway_secure

' === SECURITY FLOW SEQUENCES ===

' 1. Initial Authorization Flow
webapp --> dpop_keys : "1. Generate\nKey Pair"
webapp --> dpop_client : "2. Create DPoP\nProof"
webapp --> pkce_client : "3. Generate PKCE\nChallenge"

' 2. PAR Request
webapp --> istio_ingress : "4. PAR Request\nHTTPS + DPoP"
istio_ingress --> rate_limiting : "5. Rate Check"
rate_limiting --> cors_config : "6. CORS\nValidation"
cors_config --> par_controller : "7. PAR\nProcessing"
par_controller --> private_key_jwt : "8. Client Auth\nPrivate Key JWT"
private_key_jwt --> fapi_realm : "9. Client\nValidation"
fapi_realm --> par_controller : "10. Request URI\nGenerated"

' 3. Authorization Request
webapp --> auth_controller : "11. Auth Request\nwith Request URI"
auth_controller --> fapi_realm : "12. User\nAuthentication"
fapi_realm --> auth_controller : "13. Authorization\nCode"

' 4. Token Exchange
webapp --> token_controller : "14. Token Request\nDPoP + PKCE"
token_controller --> dpop_validator : "15. DPoP Proof\nValidation"
dpop_validator --> jti_prevention : "16. JTI Replay\nCheck"
jti_prevention --> redis_security : "17. JTI Storage\nRedis"
token_controller --> keycloak_dpop : "18. DPoP Token\nBinding"
keycloak_dpop --> token_controller : "19. DPoP-bound\nAccess Token"

' 5. API Request Flow
webapp --> istio_ingress : "20. API Request\nDPoP + Token"
istio_ingress --> security_headers : "21. FAPI Headers\nValidation"
security_headers --> fapi_interceptor : "22. FAPI\nInterception"
fapi_interceptor --> dpop_filter : "23. DPoP\nValidation"
dpop_filter --> dpop_validator : "24. Proof\nVerification"
dpop_validator --> token_binding : "25. Token Binding\nValidation"
token_binding --> security_annotations : "26. Annotation\nProcessing"
security_annotations --> method_security : "27. Authorization\nCheck"
method_security --> loan_controller : "28. Business\nLogic"

' 6. Audit and Monitoring
loan_controller --> audit_service : "29. Compliance\nLogging"
audit_service --> audit_logs : "30. Audit\nStorage"
dpop_validator --> dpop_metrics : "31. DPoP\nMetrics"
fapi_interceptor --> fapi_metrics : "32. FAPI\nMetrics"
security_headers --> security_alerts : "33. Security\nAlerting"

' 7. Data Access Security
loan_controller --> idempotency : "34. Idempotency\nCheck"
loan_controller --> postgres_security : "35. Secure\nData Access"

' 8. External Security
loan_controller --> credit_bureau : "36. External API\nmTLS"
payment_controller --> payment_gateway_secure : "37. Payment\nPCI DSS"

' === SECURITY ANNOTATIONS ===

note top of dpop_validator : "RFC 9449 Compliance:\n• HTTP Method Binding\n• URI Binding\n• Access Token Hash\n• Timestamp Validation\n• Signature Verification"

note top of jti_prevention : "JTI Replay Prevention:\n• Redis Storage\n• TTL Management\n• Cleanup Scheduling\n• Memory Efficiency"

note top of fapi_interceptor : "FAPI 2.0 Requirements:\n• X-FAPI-Interaction-ID\n• X-FAPI-Auth-Date\n• X-FAPI-Customer-IP\n• Security Headers"

note top of private_key_jwt : "Client Authentication:\n• Private Key JWT Only\n• No Client Secrets\n• Asymmetric Cryptography\n• JWT Assertion"

note top of token_binding : "DPoP Token Binding:\n• cnf Claim\n• jkt Thumbprint\n• Cryptographic Binding\n• Proof-of-Possession"

note top of postgres_security : "Database Security:\n• Encryption at Rest\n• TLS in Transit\n• Access Controls\n• Audit Logging"

' === SECURITY LEVELS ===
legend right
  |Color|Security Level|Description|
  |<color:#FF4444>Red</color>|Critical|Core security components|
  |<color:#FF8800>Orange</color>|High|Important security layers|
  |<color:#FFBB00>Yellow</color>|Medium|Application security|
  |<color:#88DD44>Green</color>|Low|Monitoring & logging|
endlegend

@enduml