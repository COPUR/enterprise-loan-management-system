# Fluent Bit Configuration for PCI-DSS Compliant Banking System
# Industry Standard Log Processing with Enhanced Security

[SERVICE]
    Flush           5
    Grace           30
    Daemon          off
    Log_Level       info
    Parsers_File    /fluent-bit/etc/parsers.conf
    HTTP_Server     On
    HTTP_Listen     0.0.0.0
    HTTP_Port       2020
    Health_Check    On
    HC_Errors_Count 5
    HC_Retry_Failure_Count 5
    HC_Period       60
    storage.path    /tmp/flb-storage/
    storage.sync    normal
    storage.checksum off
    storage.backlog off

# Input: Application Logs with PCI-DSS Filtering
[INPUT]
    Name              tail
    Tag               banking.app.*
    Path              /var/log/applications/*.log
    Multiline.parser  spring_boot
    Path_Key          file_path
    Read_from_Head    false
    Refresh_Interval  10
    Skip_Long_Lines   On
    Skip_Empty_Lines  On
    storage.type      filesystem
    Buffer_Max_Size   64k
    Mem_Buf_Limit     256MB

# Input: Audit Logs (High Priority)
[INPUT]
    Name              tail
    Tag               banking.audit.*
    Path              /var/log/applications/audit/*.log
    Multiline.parser  json
    Path_Key          audit_file
    Read_from_Head    false
    Refresh_Interval  5
    storage.type      filesystem
    Buffer_Max_Size   128k
    Mem_Buf_Limit     512MB

# Input: Security Logs
[INPUT]
    Name              tail
    Tag               banking.security.*
    Path              /var/log/applications/security/*.log
    Multiline.parser  json
    Path_Key          security_file
    Read_from_Head    false
    Refresh_Interval  5
    storage.type      filesystem
    Buffer_Max_Size   128k
    Mem_Buf_Limit     512MB

# Input: Transaction Logs (PCI Scope)
[INPUT]
    Name              tail
    Tag               banking.transaction.*
    Path              /var/log/applications/transaction/*.log
    Multiline.parser  json
    Path_Key          transaction_file
    Read_from_Head    false
    Refresh_Interval  2
    storage.type      filesystem
    Buffer_Max_Size   256k
    Mem_Buf_Limit     1024MB

# Input: Docker Container Logs
[INPUT]
    Name              forward
    Tag               docker.*
    Listen            0.0.0.0
    Port              24224
    Buffer_Max_Size   64k
    Mem_Buf_Limit     128MB

# Filter: Parse Spring Boot Logs
[FILTER]
    Name          parser
    Match         banking.app.*
    Key_Name      log
    Parser        spring_boot_json
    Reserve_Data  On
    Preserve_Key  On

# Filter: Add Environment and Compliance Metadata
[FILTER]
    Name         modify
    Match        banking.*
    Add          environment ${DATA_RESIDENCY}
    Add          compliance_standard PCI-DSS-v4
    Add          data_classification ${DATA_CLASSIFICATION:-RESTRICTED}
    Add          collection_timestamp ${timestamp}
    Add          collector_id fluent-bit-primary

# Filter: Data Masking for PCI Compliance
[FILTER]
    Name            grep
    Match           banking.*
    Exclude         message .*password.*
    Exclude         message .*credit.*card.*
    Exclude         message .*ssn.*
    Exclude         message .*social.*security.*

[FILTER]
    Name            modify
    Match           banking.*
    Condition       Key_value_matches message .*\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}.*
    Set             message [MASKED] Credit card number detected and masked
    Set             pci_data_detected true
    Set             audit_required true

# Filter: Enrich Transaction Logs
[FILTER]
    Name         lua
    Match        banking.transaction.*
    Script       /fluent-bit/scripts/pci_enrichment.lua
    Call         enrich_transaction_log

# Filter: Security Log Enhancement
[FILTER]
    Name         lua
    Match        banking.security.*
    Script       /fluent-bit/scripts/security_enrichment.lua
    Call         enrich_security_log

# Filter: Rate Limiting for High Volume Logs
[FILTER]
    Name         throttle
    Match        banking.app.*
    Rate         1000
    Window       300
    Interval     1m

# Filter: Log Level Classification
[FILTER]
    Name         modify
    Match        banking.*
    Condition    Key_value_matches level ERROR
    Add          severity_level 3
    Add          alert_required true

[FILTER]
    Name         modify
    Match        banking.*
    Condition    Key_value_matches level WARN
    Add          severity_level 2

[FILTER]
    Name         modify
    Match        banking.*
    Condition    Key_value_matches level INFO
    Add          severity_level 1

# Filter: Data Residency Routing
[FILTER]
    Name         modify
    Match        banking.*
    Condition    Key_value_equals environment eu
    Add          routing_key eu-banking-logs
    Add          gdpr_compliant true

[FILTER]
    Name         modify
    Match        banking.*
    Condition    Key_value_equals environment us
    Add          routing_key us-banking-logs
    Add          ccpa_compliant true

[FILTER]
    Name         modify
    Match        banking.*
    Condition    Key_value_equals environment apac
    Add          routing_key apac-banking-logs
    Add          local_data_protection true

# Output: OpenTelemetry Collector (Primary)
[OUTPUT]
    Name          opentelemetry
    Match         banking.*
    Host          otel-collector
    Port          4318
    Logs_uri      /v1/logs
    Log_response_payload True
    Tls           On
    Tls.verify    On
    Tls.ca_file   /etc/ssl/certs/ca.crt
    Tls.crt_file  /etc/ssl/certs/fluent-bit.crt
    Tls.key_file  /etc/ssl/private/fluent-bit.key
    Headers       X-Data-Classification PCI-DSS
    Headers       X-Source-System loan-management
    Workers       4
    storage.total_limit_size 2G

# Output: Elasticsearch for Long-term Storage
[OUTPUT]
    Name            es
    Match           banking.*
    Host            elasticsearch-secure
    Port            9200
    Index           banking-logs-${DATA_RESIDENCY}
    Type            _doc
    Logstash_Format On
    Logstash_Prefix banking-logs-${DATA_RESIDENCY}
    Logstash_DateFormat %Y.%m.%d
    Time_Key        @timestamp
    Time_Key_Format %Y-%m-%dT%H:%M:%S.%LZ
    Include_Tag_Key On
    Tag_Key         fluent_tag
    HTTP_User       ${ELASTICSEARCH_USERNAME}
    HTTP_Passwd     ${ELASTICSEARCH_PASSWORD}
    tls             On
    tls.verify      On
    tls.ca_file     /etc/ssl/certs/ca.crt
    Generate_ID     On
    Workers         2
    Retry_Limit     3

# Output: Kafka for Real-time Processing
[OUTPUT]
    Name           kafka
    Match          banking.transaction.*
    Brokers        kafka-secure:9093
    Topics         banking-transactions-${DATA_RESIDENCY}
    Timestamp_Key  @timestamp
    Format         json_lines
    rdkafka.security.protocol SASL_SSL
    rdkafka.sasl.mechanism PLAIN
    rdkafka.sasl.username ${KAFKA_USERNAME}
    rdkafka.sasl.password ${KAFKA_PASSWORD}
    rdkafka.ssl.ca.location /etc/ssl/certs/kafka-ca.crt
    rdkafka.ssl.certificate.location /etc/ssl/certs/kafka-client.crt
    rdkafka.ssl.key.location /etc/ssl/private/kafka-client.key

# Output: Audit Log Storage (Separate Topic)
[OUTPUT]
    Name           kafka
    Match          banking.audit.*
    Brokers        kafka-secure:9093
    Topics         banking-audit-${DATA_RESIDENCY}
    Timestamp_Key  @timestamp
    Format         json_lines
    rdkafka.security.protocol SASL_SSL
    rdkafka.sasl.mechanism PLAIN
    rdkafka.sasl.username ${KAFKA_USERNAME}
    rdkafka.sasl.password ${KAFKA_PASSWORD}
    rdkafka.ssl.ca.location /etc/ssl/certs/kafka-ca.crt
    rdkafka.ssl.certificate.location /etc/ssl/certs/kafka-client.crt
    rdkafka.ssl.key.location /etc/ssl/private/kafka-client.key

# Output: Security Events to SIEM
[OUTPUT]
    Name           http
    Match          banking.security.*
    Host           ${SIEM_ENDPOINT}
    Port           443
    URI            /api/v1/events
    Format         json_lines
    tls            On
    tls.verify     On
    tls.ca_file    /etc/ssl/certs/siem-ca.crt
    tls.crt_file   /etc/ssl/certs/siem-client.crt
    tls.key_file   /etc/ssl/private/siem-client.key
    Headers        X-API-Key ${SIEM_API_KEY}
    Headers        X-Data-Classification CONFIDENTIAL
    Retry_Limit    5

# Output: File Backup for Critical Logs
[OUTPUT]
    Name           file
    Match          banking.audit.*
    Path           /var/log/backup/audit
    File           audit-backup-%Y%m%d.log
    Format         json_lines
    Workers        1