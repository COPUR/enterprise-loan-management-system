@startuml OAuth2.1 Infrastructure Architecture - Banking System
!theme plain

skinparam backgroundColor #FAFAFA
skinparam package {
    BackgroundColor #F5F5F5
    BorderColor #333333
}
skinparam rectangle {
    BackgroundColor #E8F4FD
    BorderColor #2196F3
}
skinparam database {
    BackgroundColor #FF6B6B
    BorderColor #E53935
}
skinparam cloud {
    BackgroundColor #E8F5E8
    BorderColor #4CAF50
}

title OAuth2.1 Infrastructure Architecture\nEnterprise Banking System with Istio Service Mesh, Keycloak, LDAP & Party Data Management

package "Client Tier" as CLIENT_TIER {
    rectangle "Web Banking Application" as WEB_APP #FFE0B2
    rectangle "Mobile Banking App" as MOBILE_APP #FFE0B2  
    rectangle "Third-Party Financial Apps" as THIRD_PARTY #FFE0B2
    rectangle "Internal Admin Tools" as ADMIN_TOOLS #FFE0B2
}

package "Istio Service Mesh Gateway Tier" as ISTIO_TIER {
    rectangle "Istio Ingress Gateway" as ISTIO_GATEWAY #B39DDB
    rectangle "Istio Pilot" as ISTIO_PILOT #B39DDB
    rectangle "Istio Citadel" as ISTIO_CITADEL #B39DDB
    rectangle "Envoy Proxy" as ENVOY #E1BEE7
    
    note right of ISTIO_GATEWAY : **Traffic Management:**\\n- TLS Termination (TLS 1.3)\\n- OAuth2.1 Token Validation\\n- FAPI Compliance Headers\\n- Circuit Breaker Patterns\\n- Rate Limiting & DDoS Protection\\n- Load Balancing with Health Checks
    note right of ISTIO_PILOT : **Service Management:**\\n- Service Discovery\\n- Traffic Routing Rules\\n- Resilience Policies\\n- Configuration Distribution
    note right of ISTIO_CITADEL : **Security:**\\n- Certificate Management\\n- mTLS Encryption\\n- Service-to-Service Auth\\n- Zero Trust Security
    note right of ENVOY : **Sidecar Proxy:**\\n- Request Routing\\n- Metrics Collection\\n- Distributed Tracing\\n- Security Policies
}

package "OAuth2.1 Identity & Access Management" as IAM_TIER {
    rectangle "Keycloak OAuth2.1 Server" as KEYCLOAK #E3F2FD
    note right of KEYCLOAK : **Banking Realm Configuration:**\n- Client: banking-app\n- Flow: Authorization Code + PKCE\n- Session Management\n- Brute Force Protection\n- Event Logging\n- User Federation with LDAP\n\n**Banking Compliance:**\n- FAPI 1.0 Advanced\n- JWT with RS256 signing\n- Token lifecycle management\n- Multi-factor authentication\n- Audit event streaming
    
    rectangle "LDAP Identity Provider" as LDAP #F0F4C3
    note right of LDAP : **Enterprise Directory:**\n- OpenLDAP 1.5.0\n- Banking organization structure\n- TLS encryption\n- Read-only service account\n- Group membership management\n\n**User Repository:**\n- Banking employees\n- Department mapping\n- Role assignments\n- Security credentials\n- Access policies
    
    rectangle "LDAP Admin UI" as LDAP_ADMIN #F0F4C3
    note right of LDAP_ADMIN : **Management Interface:**\n- phpLDAPadmin\n- User management\n- Group administration\n- Security monitoring\n- Backup/restore
}

package "Application Services Tier" as APP_TIER {
    rectangle "Banking Application" as BANKING_APP #E8F4FD
    note right of BANKING_APP : **OAuth2.1 Resource Server:**\n- JWT token validation\n- Role-based authorization\n- Party data integration\n- Business rule enforcement\n- Compliance validation\n\n**Security Features:**\n- OWASP Top 10 protection\n- Method-level security\n- Data encryption at rest\n- Audit logging\n- Performance monitoring
    
    rectangle "Party Data Management Service" as PARTY_SERVICE #FCE4EC
    note right of PARTY_SERVICE : **Authoritative Role Source:**\n- Business role definitions\n- Temporal access control\n- Authority level management\n- Monetary limit enforcement\n- Compliance tracking\n\n**Role Sources:**\n- Database (authoritative)\n- LDAP integration\n- Keycloak synchronization\n- External system imports\n- Automated provisioning
}

package "Data Persistence Tier" as DATA_TIER {
    database "PostgreSQL Primary" as PG_PRIMARY #FF6B6B
    note right of PG_PRIMARY : **Banking Schema:**\n- customers\n- loans\n- payments\n- loan_installments\n\n**Party Management Schema:**\n- parties\n- party_roles\n- party_groups\n- role_audit_log\n\n**Keycloak Schema:**\n- keycloak tables\n- user_entity\n- realm_entity\n- client_entity\n- event_entity
    
    database "PostgreSQL Replica" as PG_REPLICA #FF6B6B
    note right of PG_REPLICA : **Read-Only Replica:**\n- Reporting queries\n- Analytics workloads\n- Backup source\n- Disaster recovery
    
    database "LDAP Data Store" as LDAP_DATA #F0F4C3
    note right of LDAP_DATA : **Directory Structure:**\n- dc=banking,dc=local\n- ou=people,ou=groups\n- ou=roles,ou=departments\n- Security credentials\n- Access control lists
}

package "Cache & Session Tier" as CACHE_TIER {
    rectangle "Redis Cluster" as REDIS #FFE0E0
    note right of REDIS : **Caching Strategy:**\n- JWT token validation cache\n- Session state storage\n- Rate limiting counters\n- Circuit breaker state\n- Party role cache\n\n**Performance:**\n- Sub-millisecond response\n- High availability cluster\n- Automatic failover\n- Memory optimization\n- TTL management
}

package "Message Streaming Tier" as STREAM_TIER {
    rectangle "Apache Kafka Cluster" as KAFKA #E0E0E0
    note right of KAFKA : **Event Topics:**\n- authentication-events\n- authorization-events\n- party-role-events\n- banking-audit-events\n- compliance-events\n\n**Integration:**\n- Keycloak event publishing\n- Banking domain events\n- Audit trail streaming\n- Real-time monitoring\n- Compliance reporting
    
    rectangle "Zookeeper Ensemble" as ZK #E0E0E0
    note right of ZK : **Cluster Coordination:**\n- Kafka cluster management\n- Leader election\n- Configuration management\n- Service discovery\n- Health monitoring
}

package "Monitoring & Observability Tier" as MONITOR_TIER {
    rectangle "Prometheus" as PROMETHEUS #E8E8FF
    note right of PROMETHEUS : **Metrics Collection:**\n- OAuth2.1 authentication metrics\n- Authorization success/failure rates\n- Token validation performance\n- Party role resolution time\n- Banking transaction metrics\n\n**Alerting:**\n- Failed authentication spikes\n- Authorization errors\n- System performance degradation\n- Compliance violations\n- Security incidents
    
    rectangle "Grafana" as GRAFANA #E8E8FF
    note right of GRAFANA : **Banking Dashboards:**\n- OAuth2.1 authentication flows\n- User access patterns\n- Role utilization metrics\n- Compliance status\n- System performance\n\n**Compliance Reporting:**\n- Access review status\n- Role assignment audit\n- Failed login analysis\n- Security event correlation\n- Regulatory reports
    
    rectangle "ELK Stack" as ELK #E8E8FF
    note right of ELK : **Log Management:**\n- Keycloak authentication logs\n- Banking application logs\n- LDAP access logs\n- Audit trail aggregation\n- Security event correlation\n\n**Search & Analytics:**\n- Real-time log search\n- Pattern detection\n- Anomaly identification\n- Forensic investigation\n- Compliance reporting
}

' Client Connections to Istio Ingress Gateway
WEB_APP --> ISTIO_GATEWAY : HTTPS/443 (TLS 1.3)
MOBILE_APP --> ISTIO_GATEWAY : HTTPS/443 (TLS 1.3)
THIRD_PARTY --> ISTIO_GATEWAY : HTTPS/443 (FAPI)
ADMIN_TOOLS --> ISTIO_GATEWAY : HTTPS/443 (TLS 1.3)

' Istio Service Mesh Internal Flow
ISTIO_GATEWAY --> ENVOY : mTLS Traffic Routing
ENVOY --> BANKING_APP : Authorized Requests (mTLS)
ENVOY --> PARTY_SERVICE : Role Resolution (mTLS)

' OAuth2.1 Authentication Flow with Istio
ISTIO_GATEWAY --> KEYCLOAK : OAuth2.1 Token Validation
ISTIO_PILOT --> ENVOY : Service Discovery & Routing
ISTIO_CITADEL --> ENVOY : Certificate Management

' Identity Federation
KEYCLOAK --> LDAP : LDAP Authentication
KEYCLOAK --> PARTY_SERVICE : Role Synchronization
LDAP_ADMIN --> LDAP : Management Interface

' Application to Services
BANKING_APP --> PARTY_SERVICE : Role Authorization
BANKING_APP --> PG_PRIMARY : Banking Data
PARTY_SERVICE --> PG_PRIMARY : Party Data

' Database Replication
PG_PRIMARY --> PG_REPLICA : Streaming Replication

' Caching Layer
ISTIO_GATEWAY --> REDIS : Token Cache
ENVOY --> REDIS : Circuit Breaker State
BANKING_APP --> REDIS : Session Cache
PARTY_SERVICE --> REDIS : Role Cache
KEYCLOAK --> REDIS : Session Store

' Event Streaming
KEYCLOAK --> KAFKA : Authentication Events
BANKING_APP --> KAFKA : Business Events
PARTY_SERVICE --> KAFKA : Role Events
KAFKA --> ZK : Cluster Coordination

' Monitoring Integration
KEYCLOAK --> PROMETHEUS : OAuth2.1 Metrics
ISTIO_GATEWAY --> PROMETHEUS : Gateway Metrics
ENVOY --> PROMETHEUS : Sidecar Metrics
ISTIO_PILOT --> PROMETHEUS : Service Mesh Metrics
BANKING_APP --> PROMETHEUS : Application Metrics
PARTY_SERVICE --> PROMETHEUS : Role Metrics
PROMETHEUS --> GRAFANA : Visualization

' Log Aggregation
KEYCLOAK --> ELK : Authentication Logs
LDAP --> ELK : Access Logs
BANKING_APP --> ELK : Application Logs
PARTY_SERVICE --> ELK : Role Audit Logs

' Health Monitoring
PROMETHEUS --> KEYCLOAK : Health Checks
PROMETHEUS --> LDAP : Health Checks
PROMETHEUS --> BANKING_APP : Health Checks
PROMETHEUS --> PARTY_SERVICE : Health Checks
PROMETHEUS --> PG_PRIMARY : Health Checks
PROMETHEUS --> REDIS : Health Checks
PROMETHEUS --> KAFKA : Health Checks

note top of KEYCLOAK
    **OAuth2.1 Configuration:**
    - Realm: banking-realm
    - Client ID: banking-app
    - Grant Type: authorization_code
    - PKCE: enabled
    - Token Signature: RS256
    - Session Timeout: 30min
    - Refresh Token: 24h
    - Access Token: 5min
end note

note bottom of PARTY_SERVICE
    **Role Resolution Logic:**
    1. Check database roles (authoritative)
    2. Validate temporal constraints
    3. Verify compliance status
    4. Apply monetary limits
    5. Enforce business unit scope
    6. Log access decisions
end note

note right of PROMETHEUS
    **Key Metrics:**
    - Authentication success rate: >99.9%
    - Token validation time: <50ms
    - Role resolution time: <100ms
    - Failed login rate: <0.1%
    - System availability: >99.95%
end note

note left of REDIS
    **Cache Configuration:**
    - JWT validation: 300s TTL
    - Session data: 1800s TTL
    - Role cache: 3600s TTL
    - Rate limits: 60s TTL
    - Circuit breaker: Persistent
end note

@enduml